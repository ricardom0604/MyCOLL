@page "/users/roles/{UserId}"

@using Microsoft.AspNetCore.Identity
@using MyCOLLDB.Model.Constants
@using Microsoft.AspNetCore.Authorization
@using MyCOLLDB.Model.Entities

@attribute [Authorize(Roles = UserRoles.Admin)]

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavManager

<h3>Gerir Permissões: @(_user?.FullName ?? "...")</h3>

@if (_user == null)
{
	<p>Carregando...</p>
}
else
{
	<div class="card p-4" style="max-width: 500px;">
		<h5>Selecione os Perfis:</h5>

		@foreach (var role in _allRoles)
		{
			<div class="form-check">
				<input class="form-check-input" type="checkbox" checked="@_userRoles.Contains(role.Name)"
					@onchange="@(e => UpdateRoleSelection(role.Name, e.Value))" id="@role.Id">
				<label class="form-check-label" for="@role.Id">
					@role.Name
				</label>
			</div>
		}

		<div class="mt-3">
			<button class="btn btn-primary" @onclick="SaveRoles">Salvar Alterações</button>
			<button class="btn btn-secondary" @onclick='() => NavManager.NavigateTo("/users")'>Cancelar</button>
		</div>
	</div>
}

@code {
	[Parameter] public string UserId { get; set; }

	private ApplicationUser? _user;
	private ICollection<IdentityRole> _allRoles = new List<IdentityRole>();
	private IList<string> _userRoles = new List<string>();

	protected override async Task OnInitializedAsync()
	{
		_user = await UserManager.FindByIdAsync(UserId);
		if (_user != null)
		{
			_allRoles = RoleManager.Roles.ToList();
			_userRoles = await UserManager.GetRolesAsync(_user);
		}
	}

	private void UpdateRoleSelection(string roleName, object? isChecked)
	{
		if (isChecked is bool checkedValue)
		{
			if (checkedValue && !_userRoles.Contains(roleName))
			{
				_userRoles.Add(roleName);
			}
			else if (!checkedValue && _userRoles.Contains(roleName))
			{
				_userRoles.Remove(roleName);
			}
		}
	}

	private async Task SaveRoles()
	{
		if (_user == null) return;

		// Obtém roles atuais da DB
		var currentRoles = await UserManager.GetRolesAsync(_user);

		// Adiciona as novas
		var toAdd = _userRoles.Except(currentRoles);
		await UserManager.AddToRolesAsync(_user, toAdd);

		// Remove as que foram desmarcadas
		var toRemove = currentRoles.Except(_userRoles);
		await UserManager.RemoveFromRolesAsync(_user, toRemove);

		NavManager.NavigateTo("/users");
	}
}
