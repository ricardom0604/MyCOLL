@page "/"
@using MyCOLL.Shared.Models.Dto
@inject HttpClient Http
@using MyCOLL.Shared.Services
@inject CartService CartService
@inject NavigationManager NavManager
<PageTitle>Home - MyCOLL</PageTitle>

<style>
	.cat-box {
		background: linear-gradient(135deg, var(--cor-topo, #00c2e0), #0090a8);
		aspect-ratio: 1/1;
		color: white;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 15px;
		transition: transform 0.3s ease, box-shadow 0.3s ease;
		text-align: center;
		padding: 10px;
	}

	.cat-box:hover {
		transform: translateY(-5px) scale(1.02);
		box-shadow: 0 10px 20px rgba(0, 194, 224, 0.3);
		cursor: pointer;
	}

	.cat-link {
		text-decoration: none;
		color: white;
	}
</style>

<div class="mb-5">
	<h3 class="mb-4" style="color: var(--cor-topo, #00bcd4); font-weight: 800;">📂 Browse Categories</h3>

	@if (_categories == null)
	{
		<div class="text-center py-3">
			<div class="spinner-grow text-info" style="color: black !important;" role="status"></div>
			<p class="text-muted small mt-2">Loading categories...</p>
		</div>
	}
	else
	{
		<div class="row g-3">
			@foreach (var cat in _categories)
			{
				<div class="col-6 col-md-3 col-lg-2">
					<a href="/category/@cat.Id" class="cat-link">
						<div class="cat-box shadow-sm">
							<div>
								<h5 class="fw-bold m-0">@cat.Name</h5>
							</div>
						</div>
					</a>
				</div>
			}
		</div>
	}
</div>

<h3 class="mb-4" style="color: var(--cor-topo, #00bcd4); font-weight: 800;">🪙 Highlights</h3>

@if (_products == null)
{
	<div class="d-flex justify-content-center p-5">
		<div class="spinner-border text-info" style="color: black !important;" role="status"></div>
	</div>
}
else
{
	<div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
		@foreach (var p in _products)
		{
			<div class="col">
				<div class="card-produto h-100 shadow-sm p-3" style="background: white; border-radius: 15px;">
					<div class="img-container" style="height: 200px; overflow: hidden; background-color: #f8f9fa;">
						@if (p.Images.Any())
						{
							var imgPath = p.Images.First().ImageUrl;
							string fullUrl;
							if (imgPath.StartsWith("http", StringComparison.OrdinalIgnoreCase))
							{
								fullUrl = imgPath;
							}
							else
							{
								fullUrl = $"{Http.BaseAddress}{imgPath.TrimStart('/')}";
							}
							<img src="@fullUrl" class="card-img-top h-100 w-100" style="object-fit: contain; padding: 10px;"
								alt="@p.Name" />
						}
						else
						{
							<div class="d-flex align-items-center justify-content-center h-100 text-muted">
								<i class="bi bi-image fs-1"></i>
							</div>
						}
					</div>
					<div class="mt-3 text-center">
						<h5 class="fw-bold mb-1 text-truncate">@p.Name</h5>
						<p class="text-muted small mb-2">@p.CategoryName</p>
						<h4 class="text-info fw-bold" style="color: var(--cor-topo, #00bcd4) !important;">
							@p.FinalPrice.ToString("0.00") €
						</h4>
						@if (p.Stock > 0)
						{
							// Só Clients e users anonimos podem ver o botão de adicionar ao carrinho e demais
							<AuthorizeView Roles="Client">
								<Authorized>
									<button class="btn btn-outline-warning w-100 rounded-pill mt-2 fw-bold"
										style="color: black; border-color: darkred;" @onclick="() => AddItemToCart(p)">
										+ Add
									</button>
								</Authorized>
								<NotAuthorized>
									<a href="/auth/login" class="btn btn-outline-primary">
										Become a Client to Buy
									</a>
								</NotAuthorized>
							</AuthorizeView>
						}
						else
						{
							<span class="badge bg-danger mb-2">Out of Stock</span>
						}
					</div>
				</div>
			</div>
		}
	</div>
}

@if (!string.IsNullOrEmpty(_error))
{
	<div class="alert alert-danger mt-4">
		<strong>An error occurred:</strong> @_error
	</div>
}

@code {
	private List<ProductDto>? _products;
	private List<CategoryDto>? _categories;
	private string _error = "";

	protected override async Task OnInitializedAsync()
	{
		try
		{
			// Busca Produtos e Categorias em paralelo
			var taskProdutos = Http.GetFromJsonAsync<List<ProductDto>>("api/Product");
			var taskCategorias = Http.GetFromJsonAsync<List<CategoryDto>>("api/Category");

			await Task.WhenAll(taskProdutos, taskCategorias);

			_products = await taskProdutos;
			// Apanha só as primeiras 8 categorias para não encher o ecrã
			_categories = (await taskCategorias)?.Take(8).ToList();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"ERROR IN HOME: {ex.Message}");
			_error = $"Unable to load the store. (Error: {ex.Message})";
		}

	}
	private void AddItemToCart(ProductDto produto)
	{
		// Chama serviço para guardar o produto
		CartService.AddToCart(produto);
	}
}
