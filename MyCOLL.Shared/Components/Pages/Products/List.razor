@page "/products/list"
@using System.Security.Claims
@using MyCOLL.Shared.Models.Dto
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject IJSRuntime JsRuntime
<div class="container mt-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3>üì¶ My Products</h3>
		<a href="/products/create" class="btn btn-success">
			+ New Product
		</a>
	</div>

	@if (_isLoading)
	{
		<div class="text-center">
			<div class="spinner-border text-primary" role="status"></div>
			<p>Loading your inventory...</p>
		</div>
	}
	else if (_myProducts.Count == 0 || !_myProducts.Any())
	{
		<div class="alert alert-info text-center">
			<h4>You don't have products for sale yet.</h4>
			<p>Click "New Product" to start selling!</p>
		</div>
	}
	else
	{
		<div class="row">
			@foreach (var p in _myProducts)
			{
				<div class="col-md-4 mb-4">
					<div class="card h-100 shadow-sm">
						<div class="img-container" style="height: 200px; overflow: hidden; background-color: #f8f9fa;">
							@if (p.Images.Any())
							{
								var imgPath = p.Images.First().ImageUrl;
								string fullUrl;
								if (imgPath.StartsWith("http", StringComparison.OrdinalIgnoreCase))
								{
									fullUrl = imgPath;
								}
								else
								{
									// Concatenate API base address with image path
									// TrimStart('/') prevents double slashes
									fullUrl = $"{Http.BaseAddress}{imgPath.TrimStart('/')}";
								}
								<img src="@fullUrl" class="card-img-top h-100 w-100" style="object-fit: contain; padding: 10px;"
									alt="@p.Name" />
							}
							else
							{
								<div class="d-flex align-items-center justify-content-center h-100 text-muted">
									<i class="bi bi-image fs-1"></i>
								</div>
							}
						</div>

						<div class="card-body">
							<h5 class="card-title">@p.Name</h5>
							<p class="card-text text-truncate">@p.Description</p>

							<div class="d-flex justify-content-between align-items-center">
								<span class="badge bg-primary fs-6">@p.FinalPrice.ToString("C")</span>
								<span class="badge bg-secondary">Stock: @p.Stock</span>
							</div>

							<div class="mt-2">
								@if (p.IsActive)
								{
									<span class="badge bg-success">Active</span>
								}
								else
								{

									<span class="badge bg-danger">Inactive</span>
								}
							</div>
						</div>

						<div class="card-footer bg-white border-top-0 d-grid gap-2">
							<a href="/products/edit/@p.Id" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Edit</a>
							<button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteProduct(p.Id)">
								üóëÔ∏è Delete
							</button>
						</div>
					</div>
				</div>
			}
		</div>
	}
</div>

@code {
	private ICollection<ProductDto> _myProducts = new List<ProductDto>();
	private bool _isLoading = true;
	private string _currentUserId = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			// 1. Identify the logged-in user
			var authState = await AuthStateProvider.GetAuthenticationStateAsync();
			var user = authState.User;

			if (user.Identity != null && user.Identity.IsAuthenticated)
			{
				_currentUserId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value ?? "";
			}

			if (!string.IsNullOrEmpty(_currentUserId))
			{
				// Fetch only the products of the logged-in supplier
				var supplierProducts = await Http.GetFromJsonAsync<List<ProductDto>>($"api/Product/sup/{_currentUserId}");
				if (supplierProducts != null)
				{
					_myProducts = supplierProducts;
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error loading products: {ex.Message}");
		}
		finally
		{
			_isLoading = false;
		}
	}

	private async Task DeleteProduct(int id)
	{
		var confirm = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this product?");
		if (confirm)
		{
			try
			{
				var response = await Http.DeleteAsync($"api/Product/{id}");
				if (response.IsSuccessStatusCode)
				{
					// Remove from list locally to avoid full reload
					var itemRemove = _myProducts.FirstOrDefault(p => p.Id == id);
					if (itemRemove != null)
					{
						_myProducts.Remove(itemRemove);
					}
				}
				else
				{
					await JsRuntime.InvokeVoidAsync("alert", "Could not delete. Please try again.");
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error: {ex.Message}");
			}
		}
	}
}
